<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">

<html>
    <head>
        <title>Тестовое приложение</title>
		<meta content="text/html; charset=utf-8" http-equiv="content-type">
    </head>
    <body id="wrp">
		<div id="sandbox">
	        <button id="payment" type="button" onclick="payment()">
				Оплатить
	        </button>
	        <button id="inviteFrineds" type="button" onclick="invite()">
	            Пригласить друзей
	        </button>
			<button id="reviewApp" type="button" onclick="review()">
	            Написать отзыв
	        </button>
			<br/>
			<br/>			
			<button id="widget" type="button" onclick="permission('widget')">
	            Разместить виджет в профиле
	        </button>
			<button id="stream" type="button" onclick="stream()">
	            Добавить запись в «Что нового»
	        </button>
			<button id="guestbook" type="button" onclick="guestbook()">
	            Добавить запись в Гостевую книгку
	        </button>
			<br/>
			<br/>			
			<button id="album" type="button" onclick="createAlbum()">
	            Создать альбом
	        </button>
			<select id="albums-select"></select>
			<button id="photo" type="button" onclick="upload()">
	            Загрузить фото
	        </button>
	        <br/>
	        <br/>
	        <button id="setIframeHeight" type="button" onclick="setIframeHeight()">
	            Установить высоту 1000
	        </button>
		</div>
		<textarea id="console" style="height: 500px; width: 100%; display: block;"></textarea>
		<script src="http://connect.mail.ru/js/loader.js" type="text/javascript" charset="utf-8"></script>
        <script type="text/javascript" charset="utf-8">
            if(typeof window.console === 'undefined'){
                window.console = {
                    log: function(d){
                        cl('console log: ' + d);
                    }
                };
            }

            function $(d){
                return document.getElementById(d) || false;
            }
            function cl(d){
                $('console').innerHTML += d + '\n';
            }
			function fillAlbumsSelect(){
				mailru.app.photos.getAlbums(function(result){
					albums = result;
					var albumsSelect = $('albums-select');
					albumsSelect.innerHTML = null;
					for(var i = 0; i < albums.length; i++){
						with(albumsSelect.appendChild(document.createElement('option'))){
							value = albums[i].aid;
							innerHTML = albums[i].aid;
						}
					};
					
					albumsSelect.style.display = 'inline';
				}, user.uid);
			}
			
            var user = {}, friends = {}, albums = null, aid = null, sandbox = document.getElementById('sandbox');
	            mailru.loader.require('api', function() {
					cl('Кросс-доменный транспорт ' + mailru.intercomType)
				
					//делаем инициализацию приложения
	                mailru.app.init('cfe0b07b0762f250c1f640f8bbf259c3');
				
					//проверяем, установлено ли приложение у пользователя
	                if(mailru.session.is_app_user != 1){
	                    sandbox.style.display = 'none';
	                    mailru.app.users.requireInstallation(['widget']);
						return false;
	                }	
				
					//получаем информацию о пользователе и сохраняем в глобаленой переменной user
	                mailru.app.users.getInfo(function(result){
	                    user = result[0];
						fillAlbumsSelect();
	                });
                
					//блок подписки на события
	                mailru.events.listen(mailru.app.events.friendsInvitation, function(d){
	                    cl(collectData(d))
	                });
	                mailru.events.listen(mailru.app.events.paymentDialogStatus, function(d){
	                    cl(collectData(d))
	                });
	                mailru.events.listen(mailru.app.events.incomingPayment, function(d){
	                    cl(collectData(d))
	                });
	                mailru.events.listen(mailru.app.events.applicationReviewStatus, function(d){
	                    cl(collectData(d))
	                });
	                mailru.events.listen(mailru.app.events.applicationSettingsStatus, function(d){
	                    cl(collectData(d))
	                });
	                mailru.events.listen(mailru.app.events.permissionsChange, function(d){
	                    cl(collectData(d))
	                });
	                mailru.events.listen(mailru.app.events.streamPublish, function(d){
	                    cl(collectData(d))
	                });
	                mailru.events.listen(mailru.app.events.guestbookPublish, function(d){
	                    cl(collectData(d))
	                });
	                mailru.events.listen(mailru.app.events.permissionDialogStatus, function(d){
	                    cl(collectData(d))
	                });
	                mailru.events.listen(mailru.app.events.upload, function(d){
	                    cl(collectData(d))
	                });
	            });

            function collectData(d){
                var o = '';
                for (var p in d){
                    if(d.hasOwnProperty(p))
                        if(typeof d[p] === 'object'){
                            o += collectData(d[p]);
                        }
                        else{
                            o += p + '->' + d[p] + '\n';
                        }
                    };
                return o;
            }
			
			//блок функций вызова api-методов
            function payment(){
                mailru.app.payments.showDialog({service_id: 1, service_name: 'вилы', sms_price: 1, other_price: 2000});
                return false;
            }

            function invite(){
                mailru.app.friends.invite({name: 'test.app invite', logo: ''});
                return false;
            }

            function review(){
                mailru.app.users.review();
                return false;
            }

            function permission(type){
                mailru.common.users.requirePermissions(type);
                return false;
            }

            function guestbook(){
                mailru.common.guestbook.publish({
					'title': 'Заголовок',
					'text': 'Текст',
                    'img_url': 'http://img-fotki.yandex.ru/get/3508/flashtuchka.19d/0_30dbb_b9d0308b_XL.jpg',
                    'action_links': [
	                    {'text': 'узнать тоже', 'href': document.location.host + '#link1'},
	                    {'text': 'еще ссылка', 'href': document.location.host + '?1=2#link2'}
                    ]
				});
                return false;
            }

            function stream(){
                mailru.common.stream.publish({
					'title': 'Заголовок',
					'text': 'Текст',
                    'img_url': 'http://bitman.me/mailru/demo/img/stream_pic.jpeg',
					'action_links': [
						{'text': 'ссылка', 'href': document.location.host + '#link1'}
					]
				});
                return false;
            }

            function createAlbum(){
                mailru.common.photos.createAlbum({name: 'Тестовый альбом' });
                mailru.events.listen(mailru.common.events.createAlbum, function(result){
                    aid = result.aid;
					fillAlbumsSelect();
                })
                return false;
            }

            function upload(){
                mailru.common.photos.upload({aid: $('albums-select').value, img: 'http://content.foto.mail.ru/corp/novikov/_connect/i-558.jpg'});
                return false;
            }
            
            function setIframeHeight(){
                mailru.app.utils.setIframeHeight(1000);
                return false;
            }

        </script>  
    </body>
</html>